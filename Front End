<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Premium Calculator - Dry Run</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- SheetJS (xlsx) for reading Excel files -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      max-width: 900px;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 10px;
    }
    .card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    label {
      font-weight: bold;
    }
    input[type="file"] {
      margin-top: 8px;
    }
    button {
      margin-top: 12px;
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }
    button#processBtn {
      background: #0066cc;
      color: white;
    }
    button#processBtn:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
    .status {
      margin-top: 10px;
      font-size: 14px;
    }
    .status.error {
      color: #b00020;
    }
    .status.success {
      color: #006400;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: left;
    }
    th {
      background: #f3f3f3;
    }
    .error-cell {
      color: #b00020;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <h1>Automated Premium Calculator (Dry Test Run)</h1>

  <div class="card">
    <p><strong>Upload Excel file</strong> with columns:</p>
    <ul>
      <li><code>DOB</code> – format: <strong>DD-MM-YYYY</strong></li>
      <li><code>Gender</code> – e.g. <strong>Male / Female / M / F</strong></li>
      <li><code>SA</code> – Sum Assured, e.g. <strong>500000</strong></li>
    </ul>

    <label for="fileInput">Select Excel file (.xlsx / .xls):</label><br />
    <input type="file" id="fileInput" accept=".xlsx,.xls" />
    <br />
    <button id="processBtn" disabled>Process File</button>

    <div id="status" class="status"></div>
  </div>

  <div class="card">
    <h2>Results</h2>
    <div id="resultsContainer">
      <p>No data processed yet.</p>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById("fileInput");
    const processBtn = document.getElementById("processBtn");
    const statusDiv = document.getElementById("status");
    const resultsContainer = document.getElementById("resultsContainer");

    let workbookData = null; // Raw SheetJS JSON for first sheet

    // Enable the button once a file is selected
    fileInput.addEventListener("change", () => {
      if (fileInput.files && fileInput.files.length > 0) {
        processBtn.disabled = false;
        statusDiv.textContent = "";
        statusDiv.className = "status";
      } else {
        processBtn.disabled = true;
      }
    });

    // Main process button click
    processBtn.addEventListener("click", () => {
      const file = fileInput.files[0];
      if (!file) {
        showStatus("Please select a file first.", true);
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });

          // Take the first sheet
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];

          // Convert to JSON: each row is an object { headerName: value }
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

          if (jsonData.length === 0) {
            showStatus("The sheet is empty.", true);
            return;
          }

          workbookData = jsonData;
          // Once we have data, process it
          const { results, anyErrors } = processPremiums(jsonData);
          renderResultsTable(results);
          if (anyErrors) {
            showStatus("Processed with some errors. Check the Error column.", true);
          } else {
            showStatus("Successfully processed all rows.", false);
          }
        } catch (err) {
          console.error(err);
          showStatus("Error reading file: " + err.message, true);
        }
      };
      reader.readAsArrayBuffer(file);
    });

    // Show status message
    function showStatus(message, isError) {
      statusDiv.textContent = message;
      statusDiv.className = "status " + (isError ? "error" : "success");
    }

    // Core business logic: calculate premiums for each row
    function processPremiums(rows) {
      // We’ll try to map columns by header name, ignoring case.
      // Expected headers (any case): DOB, Gender, SA
      let anyErrors = false;

      // Normalize header names
      // We assume all objects in rows have same keys as first row
      const headerMap = {};
      const firstRow = rows[0];
      Object.keys(firstRow).forEach(h => {
        const normalized = h.trim().toLowerCase();
        headerMap[normalized] = h;
      });

      const dobCol = headerMap["dob"];
      const genderCol = headerMap["gender"];
      const saCol = headerMap["sa"];

      if (!dobCol || !genderCol || !saCol) {
        throw new Error("Missing required columns: DOB, Gender, SA. Check header names in your Excel.");
      }

      const processed = rows.map((row, index) => {
        const originalDob = String(row[dobCol]).trim();
        const originalGender = String(row[genderCol]).trim();
        const originalSa = row[saCol];

        let premium = null;
        let error = "";

        // 1. Validate & parse DOB → age
        let age = null;
        if (!originalDob) {
          error = "DOB is empty";
        } else {
          age = calculateAgeFromDDMMYYYY(originalDob);
          if (age === null || isNaN(age)) {
            error = "Invalid DOB format (expected DD-MM-YYYY)";
          }
        }

        // 2. Gender multiplier
        let genderMultiplier = null;
        if (!error) {
          genderMultiplier = getGenderMultiplier(originalGender);
          if (genderMultiplier === null) {
            error = "Invalid gender (expected Male/Female/M/F)";
          }
        }

        // 3. Age multiplier
        let ageMultiplier = null;
        if (!error) {
          ageMultiplier = getAgeMultiplier(age);
          if (ageMultiplier === null) {
            error = "Age out of supported range (18–35)";
          }
        }

        // 4. Lakh value and premium
        if (!error) {
          const saNumber = Number(originalSa);
          if (!Number.isFinite(saNumber) || saNumber <= 0) {
            error = "Invalid SA (must be positive number)";
          } else {
            const lakhValue = saNumber / 100000; // 5 lakhs → 5

            // ASSUMPTION:
            // Premium = LakhValue × GenderMultiplier × AgeMultiplier
            premium = lakhValue * genderMultiplier * ageMultiplier;
          }
        }

        if (error) {
          anyErrors = true;
        }

        return {
          Row: index + 2, // +2 because header is row 1 in Excel
          DOB: originalDob,
          Gender: originalGender,
          SA: originalSa,
          Age: age,
          GenderMultiplier: genderMultiplier,
          AgeMultiplier: ageMultiplier,
          Premium: error ? null : premium,
          Error: error
        };
      });

      return { results: processed, anyErrors };
    }

    // Parse DOB in DD-MM-YYYY format and compute age as of today
    function calculateAgeFromDDMMYYYY(dobStr) {
      const parts = dobStr.split("-");
      if (parts.length !== 3) return null;
      let [dd, mm, yyyy] = parts;
      dd = parseInt(dd, 10);
      mm = parseInt(mm, 10);
      yyyy = parseInt(yyyy, 10);
      if (!dd || !mm || !yyyy) return null;

      // JS months are 0-based
      const birthDate = new Date(yyyy, mm - 1, dd);
      if (isNaN(birthDate.getTime())) return null;

      const today = new Date();
      let age = today.getFullYear() - birthDate.getFullYear();
      const m = today.getMonth() - birthDate.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
        age--;
      }
      return age;
    }

    // Gender multiplier
    function getGenderMultiplier(g) {
      const val = g.trim().toLowerCase();
      if (val === "male" || val === "m") return 3;
      if (val === "female" || val === "f") return 2;
      return null;
    }

    // Age multiplier
    function getAgeMultiplier(age) {
      if (age >= 18 && age <= 25) return 2;
      if (age >= 26 && age <= 35) return 3;
      return null; // unsupported range
    }

    // Render results in a table
    function renderResultsTable(rows) {
      if (!rows || rows.length === 0) {
        resultsContainer.innerHTML = "<p>No data to display.</p>";
        return;
      }

      let html = "<table><thead><tr>";
      const headers = [
        "Row",
        "DOB",
        "Gender",
        "SA",
        "Age",
        "GenderMultiplier",
        "AgeMultiplier",
        "Premium",
        "Error"
      ];
      headers.forEach(h => {
        html += "<th>" + h + "</th>";
      });
      html += "</tr></thead><tbody>";

      rows.forEach(r => {
        html += "<tr>";
        headers.forEach(h => {
          const value = r[h];
          if (h === "Error" && value) {
            html += '<td class="error-cell">' + value + "</td>";
          } else {
            html += "<td>" + (value === null || value === undefined ? "" : value) + "</td>";
          }
        });
        html += "</tr>";
      });

      html += "</tbody></table>";
      resultsContainer.innerHTML = html;
    }
  </script>
</body>
</html>
